<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web photo, vidéo et son</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f7ff;
            text-align: center;
        }

        select, button {
            padding: 10px;
            margin: 5px;
            background-color: #0070a3;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #005d8f;
        }

        video {
            width: 640px;
            height: 480px;
            border: 2px solid #0070a3;
            border-radius: 5px;
            background-color: #fff;
        }

        canvas {
            display: none;
        }

        #button-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        .download-link {
            padding: 10px;
            margin: 5px;
            background-color: #0070a3;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .download-link:hover {
            background-color: #005d8f;
        }

        .photo-download-link {
            padding: 10px;
            margin: 5px;
            background-color: #0070a3;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .photo-download-link:hover {
            background-color: #005d8f;
        }

    </style>
</head>
<body>
<video id="video" width="640" height="480" autoplay muted></video>
<div id="button-container">
    <select id="source-selector">
        <option value="camera">Webcam</option>
        <option value="screen">Partage d'écran</option>
    </select>
    <button id="capture-photo-btn">Capturer la photo</button>
    <button id="start-record-btn">Démarrer l'enregistrement vidéo et audio</button>
    <button id="stop-record-btn" style="display:none;">Arrêter l'enregistrement vidéo et audio</button>
</div>
<div id="video-download-container">
    <video id="recorded-video" width="640" height="480" controls></video>
</div>
<canvas id="canvas" width="640" height="480"></canvas>



<script>
    var sourceSelector = document.getElementById('source-selector');
    var videoElement = document.getElementById('video');
    var capturePhotoButton = document.getElementById('capture-photo-btn');
    var startRecordButton = document.getElementById('start-record-btn');
    var stopRecordButton = document.getElementById('stop-record-btn');
    var canvasElement = document.getElementById('canvas');
    var context = canvasElement.getContext('2d');
    var mediaRecorder;
    var recordedChunks = [];
    var mediaStream;

    async function startCapture() {
        var selectedSource = getSelectedSource();
        try {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (selectedSource === 'camera') {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            } else if (selectedSource === 'screen') {
                mediaStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            }
            videoElement.srcObject = mediaStream;
            mediaRecorder = new MediaRecorder(mediaStream);
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            mediaRecorder.onstop = function() {
                var outputFormat = 'mp4';
                var blob = new Blob(recordedChunks, { type: 'video/' + outputFormat });
                var videoUrl = URL.createObjectURL(blob);

                var videoElement = document.getElementById('recorded-video');
                videoElement.src = videoUrl;

                var downloadLink = document.createElement('a');
                downloadLink.href = videoUrl;
                downloadLink.download = 'recorded-video.mp4';
                downloadLink.innerHTML = 'Télécharger la vidéo';
                downloadLink.className = 'download-link';
                var downloadContainer = document.getElementById('video-download-container');
                var existingDownloadLink = document.querySelector('#video-download-container .download-link');

                if (existingDownloadLink) {
                    downloadContainer.replaceChild(downloadLink, existingDownloadLink);
                } else {
                    downloadContainer.appendChild(downloadLink);
                }

                recordedChunks = [];
            };




        } catch (error) {
            console.error('Erreur lors de l\'accès à la webcam ou au partage d\'écran : ', error);
        }
    }

    sourceSelector.addEventListener('change', startCapture);

    function getSelectedSource() {
        return sourceSelector.value;
    }

    function capturePhoto() {
        context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        var imageBase64 = canvasElement.toDataURL('image/jpeg');
        var imageElement = document.createElement('img');
        imageElement.src = imageBase64;
        document.body.appendChild(imageElement);
    }

    capturePhotoButton.addEventListener('click', capturePhoto);
    document.addEventListener('keydown', function(event) {
        if (event.code === 'Space') {
            capturePhoto();
        }
    });

    startRecordButton.addEventListener('click', function() {
        mediaRecorder.start();
        startRecordButton.style.display = 'none';
        stopRecordButton.style.display = 'block';
    });

    stopRecordButton.addEventListener('click', function() {
        mediaRecorder.stop();
        startRecordButton.style.display = 'block';
        stopRecordButton.style.display = 'none';
    });

    startCapture();
</script>
</body>
</html>
